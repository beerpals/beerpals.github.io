<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Beer Pals</title>
  <link rel="icon" type="image/png" href="img/logo.png">

  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style>

    [ng-cloak] { display: none; }
    html, body { 
      font-family: sans-serif; 
      padding: 0;
      margin: 0;
      text-align: center;
      height: 100%;
    }

    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .subtitle {
      padding: 0 10px;
    }

    .body {
      margin: 0 auto;
      width: 100%;
      max-width: 1000px;
      min-height: 600px;
      padding: 10px;
    }

    .flex-container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flex;
  display: flex;
  -webkit-flex-flow: row wrap;
  -moz-flex-flow: row wrap;
  -ms-flex-flow: row wrap;
  -ms-flex-direction: row;
  -ms-flex-wrap: wrap;
  flex-flow: row wrap;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-flex-pack:justify;
  -ms-justify-content:center;
  justify-content:center;
}

.flex-row {
  -webkit-flex: 0 0 auto;
  -moz-flex: 0 0 auto;
  -ms-flex: 0 0 auto;
  flex: 0 0 auto;
  width: 25px;
  text-align: center;
  border: 2px solid white;
}

.flex-row.title {
  text-align: right;
  padding-right: 15px;
  width: 100px;
}

.flex-row.text {
  font-size: 11px;
  font-weight: bold;
}

.center {
  text-align: center;
}

.chart {
  margin-bottom: 25px;
}

.contributions {
  -webkit-transition: background-color 250ms linear;
  -moz-transition: background-color 250ms linear;
  -o-transition: background-color 250ms linear;
  -ms-transition: background-color 250ms linear;
  transition: background-color 250ms linear;
}

.contributions-none {
  background-color: rgb(240,240,240);
}

.contributions-low {
  background-color: rgb(211,240,141);
}

.contributions-medium {
  background-color: rgb(126,213,112);
}

.contributions-high {
  background-color: rgb(0,182,75);
}

.contributions-most {
  background-color: rgb(0,122,41);
}

.flex-container.last-year {
  flex-direction: column;
}


    </style>
</head>
<body class="container" ng-app="beerApp">

<div ng-controller="BeerCtrl" class="body">
  <h1>Beer Pals</h1>

<section class="chart">
  <h4 class="center">Last Year</h4>
  <div class="flex-container last-year">

    <div class="flex-row contributions"
      ng-repeat="day in analytics.lastYearArr"
      ng-class="getContributionClass(day.length, maxLastYear)"
    >
      {{day.length}}
    </div>
  </div>
</section>


<section class="lastyear chart">
  <h4 class="center">Year</h4>
  <div class="flex-container">
    <div class="flex-row title text">
      Month
    </div>
    <div class="flex-row text" ng-repeat="month in months">
      {{strings.SHORTMONTH[$index]}}
    </div>
  </div>
  <div class="flex-container">
    <div class="flex-row title text">
      Contributions
    </div>
    <div class="flex-row contributions"
      ng-repeat="month in analytics.yearArr"
      ng-class="getContributionClass(month.length, maxYear)"
    >
    </div>
  </div>
</section>


<section class="week chart">
<h4 class="center">Week</h4>
  <div class="flex-container">
    <div class="flex-row title text">
      Day
    </div>
    <div class="flex-row text" ng-repeat="day in days">
      {{strings.SHORTDAY[$index]}}
    </div>
  </div>
  <div class="flex-container">
    <div class="flex-row title text">
      Contributions
    </div>
    <div class="flex-row contributions"
      ng-repeat="day in analytics.weekArr"
      ng-class="getContributionClass(day.length, maxWeek)"
    >
    </div>
  </div>
</section>



<section class="day chart">
  <h4 class="center">Day</h4>
  <div class="flex-container">
    <div class="flex-row title text">
      Hour
    </div>
    <div class="flex-row text" ng-repeat="hour in hours">
      {{hour}}
    </div>
  </div>
  <div class="flex-container">
    <div class="flex-row title text">
      Contributions
    </div>
    <div class="flex-row contributions"
      ng-repeat="hour in analytics.dayArr"
      ng-class="getContributionClass(hour.length, maxDay)"
    >
    </div>
  </div>
</section>



<section class="weekhours chart">
  <h4 class="center">Schedule</h4>
  <div class="flex-container">
    <div class="flex-row title text">
      Day / Hour
    </div>
    <div class="flex-row text" ng-repeat="hour in dayHours">
      {{hour}}
    </div>
  </div>

  <div ng-repeat="day in analytics.weekhoursArr" class="flex-container">
    <div class="flex-row title text">
      {{strings.DAY[$index]}}
    </div>
    <div class="flex-row contributions"
      ng-repeat="hour in day"
      ng-class="getContributionClass(hour.length, maxWeekHours)"
    >
    </div>
  </div>
</section>

  <p ng-repeat="commit in commits">
    {{commit.message}} | {{commit.date | date}}
  </p>

</div>

<script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
<script type="text/javascript" src="bower_components/lodash/dist/lodash.min.js"></script>


<script type="text/javascript">


angular.module('beerApp', []).

controller('BeerCtrl', function ($scope, $http) {

  $scope.user = 'feromakovi';

  var initArray = function(arraySize){
    var array = [];
    while(arraySize--) {
      array.push([]);
    }
    return array;
  };

  var filter = function(message){
    return /^feat.+|^chore.+|^style.+|^fix.+|^test.+/.test(message);
  };

  $scope.commits = [];
  var lastYearArr = initArray(366);
  var yearArr = initArray(12);
  var weekArr = initArray(7);
  var dayArr = initArray(24);
  var weekhoursArr = [initArray(24), initArray(24), initArray(24), initArray(24), initArray(24), initArray(24), initArray(24)];

  $scope.analytics = {
    'yearArr': yearArr,
    'weekArr': weekArr,
    'dayArr': dayArr,
    'weekhoursArr': weekhoursArr,
    'lastYearArr': lastYearArr
  };

  $http.get('https://api.github.com/repos/' + $scope.user + '/beerhub/commits', {})
  .success(function(commits){
    _.pluck(commits, 'commit').forEach(function(commit){
      if (!filter(commit.message)){
        var date = new Date(commit.author.date);

        var c = {
          'date': commit.author.date,
          'message': commit.message,
          'author': commit.author.name,
          'email': commit.author.email
        };

        var date = new Date(c.date);

        hour = date.getHours();
        day = date.getDay();
        month = date.getMonth();

        $scope.analytics['yearArr'][month].push(c);
        $scope.analytics['weekArr'][day].push(c);
        $scope.analytics['dayArr'][hour].push(c);
        $scope.analytics['weekhoursArr'][day][hour].push(c);

        var now = new Date()
        var oneYearAgo = new Date();
        oneYearAgo.setYear(now.getFullYear() - 1);
        oneYearAgo.setHours(0,0,0);

        var index = Math.floor((date - oneYearAgo) / (24 * 60 * 60 * 1000));
        $scope.analytics['lastYearArr'][index].push(c);

        $scope.commits.push(c);
      }
    });

    $scope.maxLastYear = getMax($scope.analytics.lastYearArr);
    $scope.maxYear = getMax($scope.analytics.yearArr);
    $scope.maxWeek = getMax($scope.analytics.weekArr);
    $scope.maxDay = getMax($scope.analytics.dayArr);
    $scope.maxWeekHours = getMaxDouble($scope.analytics.weekhoursArr);

    console.log($scope.analytics['lastYearArr']);
    
  });

  var getMax = function(arr){
    var max = 0;
    arr.forEach(function(item){
      if (max < item.length){
        max = item.length;
      }
    });
    return max;
  };

  var getMaxDouble = function(week){
    var max = 0;
    week.forEach(function(day){
      day.forEach(function(hour){
        if (max < hour.length){
          max = hour.length;
        }
      });
    });
    return max;
  };


  $scope.dayHours = [];
  $scope.hours = [];
  $scope.days = [];
  $scope.months = [];

  for (var dh=0; dh<24;dh++){
    $scope.dayHours.push(dh);
  }

  for (var h=0; h<24;h++){
    $scope.hours.push(h);
  }

  for (var d=0; d<7;d++){
    $scope.days.push(d);
  }

  for (var m=0; m<12;m++){
    $scope.months.push(m);
  }

  $scope.strings = {
    "DAY": {
      "0": "Sunday",
      "1": "Monday",
      "2": "Tuesday",
      "3": "Wednesday",
      "4": "Thursday",
      "5": "Friday",
      "6": "Saturday"
    },
    "MONTH": {
      "0": "January",
      "1": "February",
      "2": "March",
      "3": "April",
      "4": "May",
      "5": "June",
      "6": "July",
      "7": "August",
      "8": "September",
      "9": "October",
      "10": "November",
      "11": "December"
    },
    "SHORTDAY": {
      "0": "Sun",
      "1": "Mon",
      "2": "Tue",
      "3": "Wed",
      "4": "Thu",
      "5": "Fri",
      "6": "Sat"
    },
    "SHORTMONTH": {
      "0": "Jan",
      "1": "Feb",
      "2": "Mar",
      "3": "Apr",
      "4": "May",
      "5": "Jun",
      "6": "Jul",
      "7": "Aug",
      "8": "Sep",
      "9": "Oct",
      "10": "Nov",
      "11": "Dec"
    }
  };

  $scope.getContributionClass = function(contributions, max){
    if (contributions == 0) {
      return 'contributions-none';
    }
    else if (contributions / max <= 0.25) {
      return 'contributions-low';
    }
    else if (contributions / max <= 0.50) {
      return 'contributions-medium';
    }
    else if (contributions / max <= 0.75) {
      return 'contributions-high';
    }
    else if (contributions / max <= 1.00) {
      return 'contributions-most';
    }
  };
});


    
</script>
</body>
</html>